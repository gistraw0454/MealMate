{% extends "layout.html" %}

{% block body %}
<section class="group-page">
    <div class="group-list">
        <h3>내가 가입한 그룹</h3>
        <ul>
            {% for group in groups %}
            <li>
                <a href="/my-groups?groupId={{ group.id }}">{{ group.groupName }} ({{ group.category }})</a>
            </li>
            {% endfor %}
        </ul>
    </div>
    <div class="group-details">
        {% if selectedGroup %}
        <h3>{{ selectedGroup.groupName }}</h3>
        <p>분류: {{ selectedGroup.category }}</p>
        <p>그룹장: {{ selectedGroup.ownerName }}</p>
        <ul>
            <h4>멤버</h4>
            {% for member in selectedGroup.members %}
            <li>{{ member }}</li>
            {% endfor %}
        </ul>
        <div class="menu-checklist">
            {% if selectedGroup.menus.length > 0 %}
            <form id="exclude-menu-form" action="/group/exclude-menu/{{ selectedGroup.id }}" method="post">
                <h4>제외할 메뉴를 선택하세요:</h4>
                {% for menu in selectedGroup.menus %}
                <div>
                    <input type="checkbox" name="excludedMenus" value="{{ menu }}" id="menu-{{ loop.index }}">
                    <label for="menu-{{ loop.index }}">{{ menu }}</label>
                </div>
                {% endfor %}
                <button type="submit">제외 선택</button>
            </form>
            {% else %}
            <p>메뉴가 없습니다.</p>
            {% endif %}
        </div>
        <div>
            <button id="recommend-menu-button">메뉴 추천</button>
            <p id="recommended-menu">추천 메뉴: </p>
        </div>
        {% if userIsOwner %}
        <form action="/group/delete/{{ selectedGroup.id }}" method="post">
            <button type="submit">그룹 삭제</button>
        </form>
        <form action="/group/change-category/{{ selectedGroup.id }}" method="post">
            <select name="newCategory">
                <option value="한식">한식</option>
                <option value="중식">중식</option>
                <option value="일식">일식</option>
                <option value="양식">양식</option>
            </select>
            <button type="submit">분류 변경</button>
        </form>
        {% endif %}
        {% else %}
        <p>그룹을 선택해주세요.</p>
        {% endif %}
    </div>
</section>



<script>
    // 제외 선택 완료 알림
    document.getElementById('exclude-menu-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        fetch(e.target.action, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams(new FormData(e.target))
        })
            .then((response) => {
                if (response.ok) {
                    alert('제외 선택이 완료되었습니다.');
                } else {
                    alert('제외 선택 중 오류가 발생했습니다.');
                }
            })
            .catch((err) => console.error('Error:', err));
    });

    // 메뉴 추천
    document.getElementById('recommend-menu-button')?.addEventListener('click', async () => {
        const groupId = "{{ selectedGroup.id }}";
        try {
            const response = await fetch(`/group/recommend/${groupId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            if (response.ok) {
                const data = await response.json();
                console.log(data.recommendedMenu);
                document.getElementById('recommended-menu').textContent = `추천 메뉴: ${data.recommendedMenu}`;
            } else {
                alert('추천 메뉴를 가져오는 데 실패했습니다.');
            }
        } catch (err) {
            console.error('Error recommending menu:', err);
            alert('추천 메뉴를 가져오는 중 문제가 발생했습니다.');
        }
    });
</script>

{% endblock %}
